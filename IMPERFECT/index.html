<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css" />
    <title>Dual Audio Manipulation Demo</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 2rem;
        background: #fff;
      }

      h1 {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
      }

      .players {
        display: flex;
        gap: 3rem;
        justify-content: center;
        align-items: flex-start;
      }

      .player {
        max-width: 480px;
        width: 100%;
      }

      .control-group {
        margin-bottom: 1.2rem;
      }

      label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }

      input[type="range"] {
        width: 100%;
      }

      button {
        margin-right: 0.5rem;
      }

      #timeDisplay,
      .timeDisplay {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-top: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div class="players">
      <!-- PLAYER 1 -->
      <div class="player player-left">
        <h1>*</h1>
        <div class="control-group">
          <input type="file" class="audioFileInput" accept="audio/*" />
          <p class="fileName">No file loaded.</p>
        </div>

        <div class="control-group">
          <button class="playBtn" disabled>Play</button>
          <button class="stopBtn" disabled>Stop</button>
        </div>

        <div class="control-group">
          <label>
            Position
            <span class="timeDisplay">00:00 / 00:00</span>
          </label>
          <input
            type="range"
            class="timeSlider"
            min="0"
            max="0"
            value="0"
            step="0.01"
          />
        </div>

        <div class="control-group">
          <label>
            Volume
            <span class="volumeValue">1.00</span>
          </label>
          <input
            type="range"
            class="volume"
            min="0"
            max="2"
            value="1"
            step="0.01"
          />
        </div>

        <div class="control-group">
          <label>
            Bass Gain (dB)
            <span class="bassValue">0</span>
          </label>
          <input
            type="range"
            class="bass"
            min="-30"
            max="30"
            value="0"
            step="1"
          />
        </div>

        <div class="control-group">
          <label>
            Filter Frequency (Hz)
            <span class="filterFreqValue">500</span>
          </label>
          <input
            type="range"
            class="filterFreq"
            min="100"
            max="10000"
            value="500"
            step="10"
          />
        </div>

        <div class="control-group">
          <label>
            Speed / Pitch (playbackRate)
            <span class="speedValue">1.00</span>
          </label>
          <input
            type="range"
            class="speed"
            min="0.5"
            max="2"
            value="1"
            step="0.05"
          />
        </div>
      </div>
      <!-- PLAYER 2 (same controls) -->
      <div class="player">
        <div class="player player-right">
          <h1>*</h1>
          <div class="control-group">
            <input type="file" class="audioFileInput" accept="audio/*" />
            <p class="fileName">No file loaded.</p>
          </div>

          <div class="control-group">
            <button class="playBtn" disabled>Play</button>
            <button class="stopBtn" disabled>Stop</button>
          </div>

          <div class="control-group">
            <label>
              Position
              <span class="timeDisplay">00:00 / 00:00</span>
            </label>
            <input
              type="range"
              class="timeSlider"
              min="0"
              max="0"
              value="0"
              step="0.01"
            />
          </div>

          <div class="control-group">
            <label>
              Volume
              <span class="volumeValue">1.00</span>
            </label>
            <input
              type="range"
              class="volume"
              min="0"
              max="2"
              value="1"
              step="0.01"
            />
          </div>

          <div class="control-group">
            <label>
              Bass Gain (dB)
              <span class="bassValue">0</span>
            </label>
            <input
              type="range"
              class="bass"
              min="-30"
              max="30"
              value="0"
              step="1"
            />
          </div>

          <div class="control-group">
            <label>
              Filter Frequency (Hz)
              <span class="filterFreqValue">500</span>
            </label>
            <input
              type="range"
              class="filterFreq"
              min="100"
              max="10000"
              value="500"
              step="10"
            />
          </div>

          <div class="control-group">
            <label>
              Speed / Pitch (playbackRate)
              <span class="speedValue">1.00</span>
            </label>
            <input
              type="range"
              class="speed"
              min="0.5"
              max="2"
              value="1"
              step="0.05"
            />
          </div>
        </div>
      </div>
    </div>
    <!-- DJ SOUND EFFECTS PANEL -->
    <div class="dj-panel">
      <h2>DJ Sound Effects</h2>

      <div class="dj-buttons">
        <button class="fx-btn1" data-sound="airhorn">Airhorn</button>
        <button class="fx-btn" data-sound="scratch">Scratch</button>
        <button class="fx-btn1" data-sound="siren">Siren</button>
        <button class="fx-btn" data-sound="laser">Laser</button>
        <button class="fx-btn1" data-sound="drum">Drum Hit</button>
      </div>
    </div>

    <script>
      function formatTime(sec) {
        if (!Number.isFinite(sec)) return "00:00";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m.toString().padStart(2, "0")}:${s
          .toString()
          .padStart(2, "0")}`;
      }

      // Creates one independent audio player inside a container
      function initPlayer(container) {
        // --- DOM elements ---
        const fileInput = container.querySelector(".audioFileInput");
        const fileName = container.querySelector(".fileName");
        const playBtn = container.querySelector(".playBtn");
        const stopBtn = container.querySelector(".stopBtn");

        const timeSlider = container.querySelector(".timeSlider");
        const timeDisplay = container.querySelector(".timeDisplay");

        const volumeSlider = container.querySelector(".volume");
        const volumeValue = container.querySelector(".volumeValue");

        const bassSlider = container.querySelector(".bass");
        const bassValue = container.querySelector(".bassValue");

        const filterFreqSlider = container.querySelector(".filterFreq");
        const filterFreqValue = container.querySelector(".filterFreqValue");

        const speedSlider = container.querySelector(".speed");
        const speedValue = container.querySelector(".speedValue");

        // --- Audio state ---
        let audioContext = null;
        let audioBuffer = null;
        let sourceNode = null;
        let gainNode = null;
        let bassFilter = null;
        let mainFilter = null;

        let isPlaying = false;
        let startTime = 0;
        let pauseOffset = 0;

        function initAudioContext() {
          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();

            gainNode = audioContext.createGain();
            gainNode.gain.value = parseFloat(volumeSlider.value);

            bassFilter = audioContext.createBiquadFilter();
            bassFilter.type = "lowshelf";
            bassFilter.frequency.value = 200;
            bassFilter.gain.value = parseFloat(bassSlider.value);

            mainFilter = audioContext.createBiquadFilter();
            mainFilter.type = "lowpass";
            mainFilter.frequency.value = parseFloat(filterFreqSlider.value);

            bassFilter.connect(mainFilter);
            mainFilter.connect(gainNode);
            gainNode.connect(audioContext.destination);
          }
        }

        // Load file
        fileInput.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          initAudioContext();

          fileName.textContent = `Loaded file: ${file.name}`;
          const arrayBuffer = await file.arrayBuffer();

          audioContext.decodeAudioData(
            arrayBuffer,
            (decoded) => {
              audioBuffer = decoded;
              playBtn.disabled = false;
              stopBtn.disabled = false;

              timeSlider.min = 0;
              timeSlider.max = audioBuffer.duration;
              timeSlider.value = 0;
              pauseOffset = 0;
              isPlaying = false;
              timeDisplay.textContent = `${formatTime(0)} / ${formatTime(
                audioBuffer.duration
              )}`;
            },
            (err) => {
              console.error("Decode error:", err);
              fileName.textContent = "Error loading file.";
            }
          );
        });

        function createSource() {
          if (!audioBuffer) return;
          if (sourceNode) {
            try {
              sourceNode.stop();
            } catch (e) {}
            sourceNode.disconnect();
          }

          sourceNode = audioContext.createBufferSource();
          sourceNode.buffer = audioBuffer;
          sourceNode.playbackRate.value = parseFloat(speedSlider.value);
          sourceNode.connect(bassFilter);

          sourceNode.onended = () => {
            if (!isPlaying) return;
            isPlaying = false;
            pauseOffset = 0;
            timeSlider.value = 0;
            timeDisplay.textContent = `${formatTime(0)} / ${formatTime(
              audioBuffer.duration
            )}`;
          };
        }

        async function play() {
          if (!audioBuffer) return;
          initAudioContext();

          if (audioContext.state === "suspended") {
            await audioContext.resume();
          }

          createSource();
          startTime = audioContext.currentTime - pauseOffset;
          sourceNode.start(0, pauseOffset);
          isPlaying = true;
        }

        function stop() {
          if (sourceNode) {
            try {
              sourceNode.stop();
            } catch (e) {}
            sourceNode.disconnect();
            sourceNode = null;
          }
          isPlaying = false;
          pauseOffset = 0;
          if (audioBuffer) {
            timeSlider.value = 0;
            timeDisplay.textContent = `${formatTime(0)} / ${formatTime(
              audioBuffer.duration
            )}`;
          }
        }

        // UI events
        playBtn.addEventListener("click", () => {
          if (!audioBuffer) return;
          play();
        });

        stopBtn.addEventListener("click", () => {
          stop();
        });

        // Seek
        timeSlider.addEventListener("input", () => {
          if (!audioBuffer) return;
          const pos = parseFloat(timeSlider.value);
          timeDisplay.textContent = `${formatTime(pos)} / ${formatTime(
            audioBuffer.duration
          )}`;
        });

        timeSlider.addEventListener("change", () => {
          if (!audioBuffer) return;
          const pos = parseFloat(timeSlider.value);
          pauseOffset = pos;
          if (isPlaying) {
            play();
          }
        });

        // Volume
        volumeSlider.addEventListener("input", () => {
          const v = parseFloat(volumeSlider.value);
          volumeValue.textContent = v.toFixed(2);
          if (gainNode) gainNode.gain.value = v;
        });

        // Bass
        bassSlider.addEventListener("input", () => {
          const v = parseFloat(bassSlider.value);
          bassValue.textContent = v.toFixed(0);
          if (bassFilter) bassFilter.gain.value = v;
        });

        // Filter freq
        filterFreqSlider.addEventListener("input", () => {
          const v = parseFloat(filterFreqSlider.value);
          filterFreqValue.textContent = v.toFixed(0);
          if (mainFilter) mainFilter.frequency.value = v;
        });

        // Speed
        speedSlider.addEventListener("input", () => {
          const v = parseFloat(speedSlider.value);
          speedValue.textContent = v.toFixed(2);
          if (sourceNode) sourceNode.playbackRate.value = v;
        });

        // Time update loop
        function updateTime() {
          if (isPlaying && audioBuffer && audioContext) {
            const rate = parseFloat(speedSlider.value) || 1;
            const played =
              pauseOffset + (audioContext.currentTime - startTime) * rate;
            const clamped = Math.min(played, audioBuffer.duration);
            timeSlider.value = clamped;
            timeDisplay.textContent = `${formatTime(clamped)} / ${formatTime(
              audioBuffer.duration
            )}`;
          }
          requestAnimationFrame(updateTime);
        }
        requestAnimationFrame(updateTime);
      }

      // Initialize both players
      document.querySelectorAll(".player").forEach(initPlayer);
    </script>
  </body>
  <script src="script.js"></script>
</html>
